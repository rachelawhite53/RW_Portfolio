<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Swirler — Color & Auto-rotate</title>
<style>
body{font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial;margin:0;background:#2b2b2b;color:#eee;display:flex;justify-content:center}
.wrap{margin:36px;width:100%;max-width:1200px;display:flex;gap:20px}
.viewerBox{flex:1;position:relative;border-radius:10px;overflow:hidden;background:#444}
model-viewer{width:100%;height:720px;display:block;background:#444}
.overlaySvg{position:absolute;inset:0;pointer-events:none}
.controls{width:300px;background:#333;border-radius:10px;padding:14px;box-shadow:0 6px 18px rgba(0,0,0,.4)}
.controls h3{margin:0 0 12px 0;color:#fff}
.controls label{display:block;font-size:13px;color:#cfd8e6;margin:8px 0 6px}
.controls input[type=color],.controls input[type=number],.controls select{width:100%;padding:8px;border-radius:6px;border:1px solid #555;background:#222;color:#fff;margin-bottom:10px}
.controls button{width:100%;padding:10px;border-radius:6px;border:1px solid #556;background:linear-gradient(#0f2b44,#0b233b);color:#fff;cursor:pointer;margin-bottom:8px}
.status{font-size:13px;color:#a8c1dd;margin-top:8px}
.profileBox{margin-top:12px;padding:8px;background:#242424;border-radius:8px;border:1px solid #3a3a3a;color:#fff}
.tick{font-size:12px;color:#cbdff5}
</style>
</head>
<body>
<div class="wrap">
  <div class="viewerBox" id="viewerBox">
    <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
    <model-viewer id="mv" src="" alt="Swirler" camera-controls auto-rotate rotation-per-second="30deg" exposure="1" shadow-intensity="0.8"></model-viewer>
    <svg id="overlay" class="overlaySvg" xmlns="http://www.w3.org/2000/svg"></svg>
  </div>

  <div class="controls">
    <h3>Controls</h3>
    <button id="loadBtn">Load model</button>
    <button id="resetBtn">Reset view</button>
    <label>Environment</label>
    <select id="envSel">
      <option value="dark">Dark Gray</option>
      <option value="light">Light Gray</option>
    </select>

    <label>Part color</label>
    <input id="colorPicker" type="color" value="#ff8833" />
    <button id="applyColor">Apply color to part</button>

    <label>Auto rotate</label>
    <button id="autoRotateBtn">Auto rotate: ON</button>

    <div class="profileBox">
      <div class="tick">Dimensions (glTF units)</div>
      <div style="display:flex;justify-content:space-between;margin-top:6px">
        <div>W (X)</div><div id="dimX">—</div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:6px">
        <div>H (Y)</div><div id="dimY">—</div>
      </div>
      <div style="display:flex;justify-content:space-between;margin-top:6px">
        <div>D (Z)</div><div id="dimZ">—</div>
      </div>
    </div>

    <div class="status" id="status">Model not loaded</div>
  </div>
</div>

<script>
const MODEL_PATH = './swirler.gltf';
const mv = document.getElementById('mv');
const loadBtn = document.getElementById('loadBtn');
const resetBtn = document.getElementById('resetBtn');
const envSel = document.getElementById('envSel');
const colorPicker = document.getElementById('colorPicker');
const applyColor = document.getElementById('applyColor');
const autoRotateBtn = document.getElementById('autoRotateBtn');
const dimX = document.getElementById('dimX');
const dimY = document.getElementById('dimY');
const dimZ = document.getElementById('dimZ');
const status = document.getElementById('status');

let materialsReady = false;
let cachedSize = null;
let currentMaterials = [];

function setEnvironment(value){
  if(value==='light'){ viewerBox.style.background='#d9d9d9'; mv.style.background='#d9d9d9'; document.body.style.background='#e6e6e6'; document.body.style.color='#111' }
  else { viewerBox.style.background='#444'; mv.style.background='#444'; document.body.style.background='#2b2b2b'; document.body.style.color='#eee' }
}
envSel.addEventListener('change', ()=> setEnvironment(envSel.value));

loadBtn.addEventListener('click', async () => {
  status.textContent = 'Loading model...';
  mv.src = MODEL_PATH;
  try{
    const resp = await fetch(MODEL_PATH);
    const gltf = await resp.json();
    let posIdx = null;
    outer: for(const mesh of gltf.meshes||[]){ if(!mesh.primitives) continue; for(const prim of mesh.primitives){ if(prim.attributes && prim.attributes.POSITION !== undefined){ posIdx = prim.attributes.POSITION; break outer } } }
    if(posIdx===null || !gltf.accessors || !gltf.accessors[posIdx]){ status.textContent = 'POSITION accessor missing'; return }
    const acc = gltf.accessors[posIdx];
    if(!acc.min || !acc.max){ status.textContent = 'Accessor min/max missing'; return }
    const min = acc.min, max = acc.max;
    cachedSize = [max[0]-min[0], max[1]-min[1], max[2]-min[2]];
    dimX.textContent = cachedSize[0].toFixed(4);
    dimY.textContent = cachedSize[1].toFixed(4);
    dimZ.textContent = cachedSize[2].toFixed(4);
    status.textContent = 'Model loaded';
  }catch(e){
    status.textContent = 'Failed to load glTF JSON';
  }
});

mv.addEventListener('load', () => {
  try{
    const model = mv.model;
    if(model && model.materials){
      currentMaterials = model.materials;
      materialsReady = true;
    } else {
      currentMaterials = [];
      materialsReady = false;
    }
  }catch(e){ materialsReady = false }
});

applyColor.addEventListener('click', () => {
  if(!materialsReady){ status.textContent = 'Materials not ready yet'; return }
  const hex = colorPicker.value.replace('#','');
  const r = parseInt(hex.substring(0,2),16)/255;
  const g = parseInt(hex.substring(2,4),16)/255;
  const b = parseInt(hex.substring(4,6),16)/255;
  currentMaterials.forEach(m=>{
    if(m.pbrMetallicRoughness && typeof m.pbrMetallicRoughness.setBaseColorFactor === 'function'){
      try{ m.pbrMetallicRoughness.setBaseColorFactor([r,g,b,1]) }catch(e){}
    }
  });
  status.textContent = 'Color applied';
});

let rotating = true;
autoRotateBtn.addEventListener('click', () => {
  rotating = !rotating;
  if(rotating){ mv.setAttribute('auto-rotate',''); autoRotateBtn.textContent='Auto rotate: ON' } else { mv.removeAttribute('auto-rotate'); autoRotateBtn.textContent='Auto rotate: OFF' }
});

resetBtn.addEventListener('click', ()=>{ try{ mv.resetPose && mv.resetPose() }catch(e){}; mv.cameraOrbit='0deg 75deg 2.5m' });

</script>
</body>
</html>